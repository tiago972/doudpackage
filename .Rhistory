{
print(paste("to num", colnames(bdd_vf)[i], sep="_"))
bdd_vf[,i]<-as.numeric(bdd_vf[,i])}
}
}
bdd_vf$charleson = NA
table(bdd_vf$K, bdd_vf$typeK)
bdd_vf$K<-as.factor(ifelse(bdd_vf$typeK == "Sein", 1,
ifelse(bdd_vf$K==1, 1, ifelse(bdd_vf$K==0, 0, NA))))
bdd_vf$typeK= gsub(".*met.*", "meta", bdd_vf$typeK, ignore.case = TRUE)
bdd_vf$charleson<-ifelse(bdd_vf$diab==1, 1, 0) + ifelse(bdd_vf$bpco == 1, 1, 0) + ifelse(bdd_vf$ugd == 1, 1, 0) +
ifelse(bdd_vf$demence == 1, 2, 0) + ifelse(bdd_vf$avc==1, 1, 0)  + ifelse(bdd_vf$aomi ==1, 1, 0) + ifelse(bdd_vf$icard == 1, 1, 0) +
ifelse(bdd_vf$icoro == 1, 1, 0) + ifelse(bdd_vf$K==1, 2, 0) + ifelse(bdd_vf$hemi_par == 1, 2, 0) + ifelse(bdd_vf$irenC == 1, 1, 0) +
ifelse(bdd_vf$typeK=="meta", 6, 0)
bdd_vf$charleson[bdd_vf$typeK=="LYMPHOME+ CANCER SEIN"]<- bdd_vf$charleson[bdd_vf$typeK=="LYMPHOME+ CANCER SEIN"] + 2
bdd_vf$charlson_ajuste<-as.numeric(ifelse(bdd_vf$age <= 79, bdd_vf$charleson + 3,
ifelse(bdd_vf$age <= 89, bdd_vf$charleson + 4,
ifelse (bdd_vf$age >= 90, bdd_vf$charleson + 5, NA))))
for (i in 1:ncol(bdd_vf))
if (is.factor(bdd_vf[,i]) && colnames(bdd_vf)[i] != "sevrage_iec_ara2" && colnames(bdd_vf)[i] != "hep_prev")
levels(bdd_vf[,i])[levels(bdd_vf[,i])=="ND" | levels(bdd_vf[,i]) =="NC" | levels(bdd_vf[,i]) == "" | levels(bdd_vf[,i]) == "?" | levels(bdd_vf[,i]) == "nd"] <-NA
bdd_vf$qsofa_preH<-as.numeric(as.character(bdd_vf$hypoTA_preH)) + as.numeric(as.character(bdd_vf$confusion)) +
as.numeric(as.character(bdd_vf$DRA))
bdd_vf$qsofa_evol<-ifelse(bdd_vf$hypoTA_evol==1, 1, 0) +
ifelse(bdd_vf$confusion_evol==1, 1, 0) +
ifelse(bdd_vf$DRA_evol==1, 1, 0)
bdd_vf$date_DC[bdd_vf$X=="287"] <- "23/04/20"
bdd_vf$date_DC<-gsub("/20$", "/2020", bdd_vf$date_DC)
bdd_vf$date_DC<-as.Date(bdd_vf$date_DC, "%d/%m/%Y")
summary(bdd_vf$date_DC)
bdd_vf$date_symp<-as.character(bdd_vf$date_symp)
bdd_vf$date_symp[bdd_vf$X=="576"] <- "27/01/2020"
bdd_vf$date_symp<-gsub("/20$", "/2020", bdd_vf$date_symp)
bdd_vf$date_symp<-gsub("/2030$", "/2020", bdd_vf$date_symp)
bdd_vf$date_symp<-as.Date(bdd_vf$date_symp, "%d/%m/%Y")
summary(bdd_vf$date_symp)
bdd_vf$date_eh<-gsub("/20$", "/2020", bdd_vf$date_eh)
bdd_vf$date_eh<-as.Date(bdd_vf$date_eh, "%d/%m/%Y")
summary(bdd_vf$date_eh)
bdd_vf$date_uga<-gsub("/20$", "/2020", bdd_vf$date_uga)
bdd_vf$date_uga<-as.Date(bdd_vf$date_uga, "%d/%m/%Y")
summary(bdd_vf$date_uga)
bdd_vf$date_s<-gsub("/20$", "/2020", bdd_vf$date_s)
bdd_vf$date_s<-as.Date(bdd_vf$date_s, "%d/%m/%Y")
summary(bdd_vf$date_s)
bdd_vf$DMS<- as.numeric(bdd_vf$date_s- bdd_vf$date_uga)
bdd_vf$surv <- as.numeric(bdd_vf$date_s - bdd_vf$date_symp)
bdd_vf$surv<-as.numeric(ifelse(bdd_vf$surv < 0, NA, bdd_vf$surv))
bdd_vf$delais_hospit<-as.numeric(bdd_vf$date_uga - bdd_vf$date_symp)
summary(bdd_vf$delais_hospit)
bdd_vf$delais_hospit[bdd_vf$delais_hospit < 0]<- NA
bdd_vf$date_intro_cortico
bdd_vf$date_intro_cortico<-gsub("/20$", "/2020", bdd_vf$date_intro_cortico)
bdd_vf$date_intro_cortico[bdd_vf$date_intro_cortico=="30-mars"]<-"03/03/2020"
bdd_vf$date_intro_cortico[bdd_vf$date_intro_cortico==""]<-NA
bdd_vf$date_intro_cortico<-as.Date(bdd_vf$date_intro_cortico, "%d/%m/%Y")
summary(bdd_vf$date_intro_cortico)
bdd_vf$delais_intro_ctc<-as.numeric(bdd_vf$date_intro_cortico - bdd_vf$date_uga)
bdd_vf$prov<-gsub(".*dom.*", "Domicile", bdd_vf$prov, ignore.case = TRUE)
bdd_vf$prov<-gsub(".*SAU.*|.*urg.*", "SAU", bdd_vf$prov, ignore.case = TRUE)
bdd_vf$prov<-gsub(".*m(é|e).*|.*chir.*|.*orth.*|.*mco.*|.*UGA.*", "MCO", bdd_vf$prov, ignore.case = TRUE)
bdd_vf$prov<-gsub(".*EHPAD.*|.*SLD.*", "Domicile", bdd_vf$prov, ignore.case = TRUE)
bdd_vf$prov<-gsub(".*ssr.*", "SSR", bdd_vf$prov, ignore.case = TRUE)
bdd_vf$prov<-ifelse(bdd_vf$prov != "" & bdd_vf$prov != "Domicile" &
bdd_vf$prov != "MCO" & bdd_vf$prov != "SAU"
& bdd_vf$prov != "SSR", "MCO", bdd_vf$prov)
bdd_vf$prov <- as.factor(bdd_vf$prov)
levels(bdd_vf$prov)[levels(bdd_vf$prov)==""] <- NA
summary(bdd_vf$prov)
bdd_vf$IMC<-as.numeric(ifelse(bdd_vf$IMC==0, NA, bdd_vf$IMC))
bdd_vf$IMC <- as.numeric(ifelse(is.na(bdd_vf$IMC) & !is.na(as.numeric(bdd_vf$poids) & !is.na(as.numeric(bdd_vf$taille))),
bdd_vf$poids/(bdd_vf$taille^2), bdd_vf$IMC))
bdd_vf$IMC[bdd_vf$IMC==max(bdd_vf$IMC, na.rm = TRUE)]<-NA
bdd_vf$infection_evol[bdd_vf$infection_evol==2]<-NA
bdd_vf$IRA<-as.factor(ifelse(bdd_vf$creat_max >= bdd_vf$creat_ref + bdd_vf$creat_ref * 30/100, 1, 0))
levels(bdd_vf$hemorragie_evol)[levels(bdd_vf$hemorragie_evol)=="Infarctus splénique + Ischémie des 2 pieds"]<-"1"
bdd_vf$temp<-as.factor(ifelse(as.numeric(bdd_vf$temp) >= 37.8, 1, ifelse(is.na(as.numeric(bdd_vf$temp)), NA, 0)))
bdd_vf$temp_evol<-as.factor(ifelse(bdd_vf$temp_max_evol >= 37.7 | bdd_vf$temp_min_evol<=35.6, 1,
ifelse(is.na(bdd_vf$temp_max_evol) & is.na(bdd_vf$temp_min_evol), NA, 0)))
bdd_vf$ipp_tot<-as.factor(ifelse(bdd_vf$IPP == 1 | bdd_vf$IPP_TAD == 1, 1,
ifelse(bdd_vf$IPP == 0 | bdd_vf$IPP_TAD == 0, 0, NA)))
bdd_vf$AC_tot<-as.factor(ifelse(bdd_vf$ACC_preH == 1 | bdd_vf$ACC_evol == 1 | bdd_vf$hep_prev == 1, 1,
ifelse(is.na(bdd_vf$ACC_preH) & is.na(bdd_vf$ACC_evol) & is.na(bdd_vf$hep_prev), NA, 0)))
bdd_vf$oxygene<-as.factor(ifelse(bdd_vf$oxygene != 0 & bdd_vf$oxygene != 1, NA, bdd_vf$oxygene))
bdd_vf$agueusie<-as.factor(ifelse(bdd_vf$agueusie==6, NA, bdd_vf$agueusie))
bdd_vf$myalgie<-as.factor(ifelse(bdd_vf$myalgie=="à", NA, bdd_vf$myalgie))
bdd_vf<-bdd_vf %>% filter(age != min(age, na.rm = TRUE))
bdd_vf$adl_quali<-as.factor(ifelse(bdd_vf$ADL6 >= 4, 1,
ifelse(is.na(bdd_vf$ADL6), NA, 0)))
bdd_vf$infection_evol<-as.factor(ifelse(bdd_vf$infection_evol == "2", NA,
as.factor(bdd_vf$infection_evol)))
bdd_vf$infection_evol<-droplevels(bdd_vf$infection_evol)
summary(bdd_vf$infection_evol)
bdd_vf$marbure_evol<-as.factor(ifelse(bdd_vf$marbure_evol == "0+DK43", NA,
as.factor(bdd_vf$marbure_evol)))
bdd_vf$ACC_tot<-as.factor(ifelse(bdd_vf$ACC_evol==1 | bdd_vf$ACC_preH == 1, 1,
ifelse(is.na(bdd_vf$ACC_preH) | is.na(bdd_vf$ACC_evol), NA, 0)))
summary(bdd_vf$ACC_tot)
bdd_vf$o2Max2<-as.factor(ifelse(is.na(bdd_vf$o2Max) | bdd_vf$o2Max < 6, 0, 1))
bdd_vf$deces[is.na(bdd_vf$deces)] <-0
##### Subset final ####
bdd_subset <- bdd_vf %>%
select ("centre", "n_centre", "age", "sexe", "depression","demence","icard" ,"avc", "park", "hta", "diab", "acfa", "obese", "icoro", "irenC", "mtev", "K", "bpco", "ugd", "charleson","charlson_ajuste",
"AAP", "AVK", "AOD", "IEC", "ara2", "BB", "IPP_TAD", "bzd", "nlp", "nb_medoc" ,"institution", "ADL6", "adl_quali" , "Rockwood", "temp", "hypoTA_preH", "asthenie",
"dyspnee", "toux", "DT", "myalgie", "cephalee", "douleur_phar", "diarrhee","qsofa_preH" ,"nausee_vomissement", "douleur_abdo", "confusion", "anosmie", "agueusie", "cont_noS",
"infNoso", "pcr_pos", "anomalie_imagerie", "delais_hospit","OAP_evol", "sca_evol", "DT_evol", "FA_parox", "DRA_evol", "IRA", "confusion_evol", "mtev_evol",
"hemorragie_evol", "temp_evol","dyspnee_evol","AVC_evol", "diarree_evol", "asthenie_evol", "escarre_evol","fecalome_evol", "globe_evol", "hypoTA_evol", "qsofa_evol", "devenir", "lata_evol", "Leuco.Max",
"lympho", "Hb.MIN", "Thrombopenie.NADIR", "creat_max", "Na_max", "K_min", "alb", "cytolyse", "cholestase", "LDH.max", "CRP.max", "PCT.MAX", "Ferritine.max",
"ARV", "cortico", "HCQ", "immunoM", "oxygene", "VNI", "ATB", "IPP", "transfu_evol", "mida", "morphine", "hep_prev", "ACC_preH", "ACC_evol",
"ipp_tot", "AC_tot", "sevrage_iec_ara2", "deces", "prov", "DMS", "date_intro_cortico", "delais_intro_ctc", "ACC_tot", "rea_evol", "o2Max2","surv")
summary(bdd_subset)
bdd_subset$Leuco.Max<-ifelse(bdd_subset$Leuco.Max > 1000, bdd_subset$Leuco.Max/1000, bdd_subset$Leuco.Max)
bdd_subset$lympho<-ifelse(bdd_subset$lympho > 100, bdd_subset$lymphox/1000, bdd_subset$lympho)
bdd_subset$age_quali<-as.factor(ifelse(bdd_subset$age <= 79, "70-79",
ifelse(bdd_subset$age <= 85, "80-85",
ifelse(bdd_subset$age <= 90, "86-90", "> 90"))))
bdd_subset$dyspnee<-as.factor(ifelse(is.na(bdd_vf$dyspnee) & bdd_vf$FR >= 22, 1,
ifelse(bdd_vf$dyspnee==1, 1, 0)))
bdd_subset$qsofa_quali_preH<-as.factor(ifelse(bdd_vf$qsofa_preH >=2, 1,
ifelse(bdd_vf$qsofa_preH < 2, 0, NA)))
bdd_subset$qsofa_quali_evol<-as.factor(ifelse(bdd_vf$qsofa_evol >=2, 1,
ifelse(bdd_vf$qsofa_evol < 2, 0,
NA)))
tmp<-filter(bdd_subset, !is.na(bdd_subset$anomalie_imagerie))
chisq.test(bdd_subset$anomalie_imagerie~bdd_subset$deces)
chisq.test(bdd_subset$anomalie_imagerie, bdd_subset$deces)
?chisq.test
wilcox.test(bdd_subset$deces~bdd_subset$anomalie_imagerie)
chisq.test(bdd_subset$deces~bdd_subset$anomalie_imagerie)
chisq.test(bdd_subset$deces, bdd_subset$anomalie_imagerie)
table(bdd_subset$deces, bdd_subset$anomalie_imagerie, deparse.level = 2)
table(tmp$deces, tmp$anomalie_imagerie, deparse.level = 2)
############################# Modele final #################################
library(lme4)
tmp_mod<-tmp %>% select("sexe", "asthenie", "anomalie_imagerie",
"adl_quali",
"charlson_ajuste", "qsofa_quali_preH", "deces", "centre", "surv")
tmp_mod$anomalie_imagerie<-addNA(tmp$anomalie_imagerie)
tmp_mod$adl_quali<-relevel(tmp_mod$adl_quali, ref="1")
tmp_mod$charlson_ajuste<-as.factor(ifelse(tmp_mod$charlson_ajuste >=7, 1, 0))
tmp_mod <-tmp %>% filter(!is.na(sexe), !is.na(asthenie),
!is.na(adl_quali), !is.na(charlson_ajuste), !is.na(qsofa_quali_preH))
tmp_mod$adl_quali<-relevel(tmp_mod$adl_quali, ref = "1")
reg_log_fin<-glmer(deces ~ sexe + asthenie + anomalie_imagerie + adl_quali +
charlson_ajuste +
(1|centre) + qsofa_quali_preH, data=tmp_mod,
family='binomial', nAGQ=20, control = glmerControl(optimizer = "bobyqa",
optCtrl=list(maxfun=1e6)))
reg<-summary(reg_log_fin)
reg
?install_github
install_github("tiago972/doudpackage")
library(doudpackage)
help(package="doudpackage")
464+55
install.packages("devtools")
require(devtools)
install_github("tiago972/doudpackage")
library(doudpackage)
install.packages("devtools")
require(devtools)
install_github("tiago972/doudpackage")
library(doudpackage)
exp(coef(reg))
exp(confint(coef(reg)))
exp(confint(reg)*)
exp(confint(reg))
confint(reg)
exp(confint(reg_log_fin, parm="beta_", method="Wald"))
setwd("/Users/Tiago/Desktop/BF is cool/gerocovid/bases")
require(dplyr)
require(lubridate)
bdd_vf<-read.csv2("bdd_cons.csv")
summary(bdd_vf)
# Dernieres lignes de DM sur la base finale:
bdd_vf$centre<-gsub("psl", "PSL", bdd_vf$centre)
bdd_vf$centre<-gsub("abc", "ABC", bdd_vf$centre)
bdd_vf$centre<-gsub("mondor", "HMN", bdd_vf$centre, ignore.case = TRUE)
for (i in 1:ncol(bdd_vf)){
if (i <= ncol(bdd_vf) && ((is.numeric(bdd_vf[,i]) && mean(bdd_vf[,i], na.rm = TRUE) < 1) || is.character(bdd_vf[,i])))
{
print(paste("to factor", colnames(bdd_vf)[i], sep="_"))
bdd_vf[,i]<-as.factor(as.character(bdd_vf[,i]))
}
if (nlevels(bdd_vf[,i]) > 5 && colnames(bdd_vf)[i] != "centre"){
print(paste("to char", colnames(bdd_vf)[i], sep="_"))
bdd_vf[,i]<-as.character(bdd_vf[,i])
if (!is.na(mean(as.numeric(bdd_vf[,i]), na.rm = TRUE)) && colnames(bdd_vf)[i] != "typeK")
{
print(paste("to num", colnames(bdd_vf)[i], sep="_"))
bdd_vf[,i]<-as.numeric(bdd_vf[,i])}
}
}
bdd_vf$charleson = NA
table(bdd_vf$K, bdd_vf$typeK)
bdd_vf$K<-as.factor(ifelse(bdd_vf$typeK == "Sein", 1,
ifelse(bdd_vf$K==1, 1, ifelse(bdd_vf$K==0, 0, NA))))
bdd_vf$typeK= gsub(".*met.*", "meta", bdd_vf$typeK, ignore.case = TRUE)
bdd_vf$charleson<-ifelse(bdd_vf$diab==1, 1, 0) + ifelse(bdd_vf$bpco == 1, 1, 0) + ifelse(bdd_vf$ugd == 1, 1, 0) +
ifelse(bdd_vf$demence == 1, 2, 0) + ifelse(bdd_vf$avc==1, 1, 0)  + ifelse(bdd_vf$aomi ==1, 1, 0) + ifelse(bdd_vf$icard == 1, 1, 0) +
ifelse(bdd_vf$icoro == 1, 1, 0) + ifelse(bdd_vf$K==1, 2, 0) + ifelse(bdd_vf$hemi_par == 1, 2, 0) + ifelse(bdd_vf$irenC == 1, 1, 0) +
ifelse(bdd_vf$typeK=="meta", 6, 0)
bdd_vf$charleson[bdd_vf$typeK=="LYMPHOME+ CANCER SEIN"]<- bdd_vf$charleson[bdd_vf$typeK=="LYMPHOME+ CANCER SEIN"] + 2
bdd_vf$charlson_ajuste<-as.numeric(ifelse(bdd_vf$age <= 79, bdd_vf$charleson + 3,
ifelse(bdd_vf$age <= 89, bdd_vf$charleson + 4,
ifelse (bdd_vf$age >= 90, bdd_vf$charleson + 5, NA))))
for (i in 1:ncol(bdd_vf))
if (is.factor(bdd_vf[,i]) && colnames(bdd_vf)[i] != "sevrage_iec_ara2" && colnames(bdd_vf)[i] != "hep_prev")
levels(bdd_vf[,i])[levels(bdd_vf[,i])=="ND" | levels(bdd_vf[,i]) =="NC" | levels(bdd_vf[,i]) == "" | levels(bdd_vf[,i]) == "?" | levels(bdd_vf[,i]) == "nd"] <-NA
bdd_vf$qsofa_preH<-as.numeric(as.character(bdd_vf$hypoTA_preH)) + as.numeric(as.character(bdd_vf$confusion)) +
as.numeric(as.character(bdd_vf$DRA))
bdd_vf$qsofa_evol<-ifelse(bdd_vf$hypoTA_evol==1, 1, 0) +
ifelse(bdd_vf$confusion_evol==1, 1, 0) +
ifelse(bdd_vf$DRA_evol==1, 1, 0)
bdd_vf$date_DC[bdd_vf$X=="287"] <- "23/04/20"
bdd_vf$date_DC<-gsub("/20$", "/2020", bdd_vf$date_DC)
bdd_vf$date_DC<-as.Date(bdd_vf$date_DC, "%d/%m/%Y")
summary(bdd_vf$date_DC)
bdd_vf$date_symp<-as.character(bdd_vf$date_symp)
bdd_vf$date_symp[bdd_vf$X=="576"] <- "27/01/2020"
bdd_vf$date_symp<-gsub("/20$", "/2020", bdd_vf$date_symp)
bdd_vf$date_symp<-gsub("/2030$", "/2020", bdd_vf$date_symp)
bdd_vf$date_symp<-as.Date(bdd_vf$date_symp, "%d/%m/%Y")
summary(bdd_vf$date_symp)
bdd_vf$date_eh<-gsub("/20$", "/2020", bdd_vf$date_eh)
bdd_vf$date_eh<-as.Date(bdd_vf$date_eh, "%d/%m/%Y")
summary(bdd_vf$date_eh)
bdd_vf$date_uga<-gsub("/20$", "/2020", bdd_vf$date_uga)
bdd_vf$date_uga<-as.Date(bdd_vf$date_uga, "%d/%m/%Y")
summary(bdd_vf$date_uga)
bdd_vf$date_s<-gsub("/20$", "/2020", bdd_vf$date_s)
bdd_vf$date_s<-as.Date(bdd_vf$date_s, "%d/%m/%Y")
summary(bdd_vf$date_s)
bdd_vf$DMS<- as.numeric(bdd_vf$date_s- bdd_vf$date_uga)
bdd_vf$surv <- as.numeric(bdd_vf$date_s - bdd_vf$date_symp)
bdd_vf$surv<-as.numeric(ifelse(bdd_vf$surv < 0, NA, bdd_vf$surv))
bdd_vf$delais_hospit<-as.numeric(bdd_vf$date_uga - bdd_vf$date_symp)
summary(bdd_vf$delais_hospit)
bdd_vf$delais_hospit[bdd_vf$delais_hospit < 0]<- NA
bdd_vf$date_intro_cortico
bdd_vf$date_intro_cortico<-gsub("/20$", "/2020", bdd_vf$date_intro_cortico)
bdd_vf$date_intro_cortico[bdd_vf$date_intro_cortico=="30-mars"]<-"03/03/2020"
bdd_vf$date_intro_cortico[bdd_vf$date_intro_cortico==""]<-NA
bdd_vf$date_intro_cortico<-as.Date(bdd_vf$date_intro_cortico, "%d/%m/%Y")
summary(bdd_vf$date_intro_cortico)
bdd_vf$delais_intro_ctc<-as.numeric(bdd_vf$date_intro_cortico - bdd_vf$date_uga)
bdd_vf$prov<-gsub(".*dom.*", "Domicile", bdd_vf$prov, ignore.case = TRUE)
bdd_vf$prov<-gsub(".*SAU.*|.*urg.*", "SAU", bdd_vf$prov, ignore.case = TRUE)
bdd_vf$prov<-gsub(".*m(é|e).*|.*chir.*|.*orth.*|.*mco.*|.*UGA.*", "MCO", bdd_vf$prov, ignore.case = TRUE)
bdd_vf$prov<-gsub(".*EHPAD.*|.*SLD.*", "Domicile", bdd_vf$prov, ignore.case = TRUE)
bdd_vf$prov<-gsub(".*ssr.*", "SSR", bdd_vf$prov, ignore.case = TRUE)
bdd_vf$prov<-ifelse(bdd_vf$prov != "" & bdd_vf$prov != "Domicile" &
bdd_vf$prov != "MCO" & bdd_vf$prov != "SAU"
& bdd_vf$prov != "SSR", "MCO", bdd_vf$prov)
bdd_vf$prov <- as.factor(bdd_vf$prov)
levels(bdd_vf$prov)[levels(bdd_vf$prov)==""] <- NA
summary(bdd_vf$prov)
bdd_vf$IMC<-as.numeric(ifelse(bdd_vf$IMC==0, NA, bdd_vf$IMC))
bdd_vf$IMC <- as.numeric(ifelse(is.na(bdd_vf$IMC) & !is.na(as.numeric(bdd_vf$poids) & !is.na(as.numeric(bdd_vf$taille))),
bdd_vf$poids/(bdd_vf$taille^2), bdd_vf$IMC))
bdd_vf$IMC[bdd_vf$IMC==max(bdd_vf$IMC, na.rm = TRUE)]<-NA
bdd_vf$infection_evol[bdd_vf$infection_evol==2]<-NA
bdd_vf$IRA<-as.factor(ifelse(bdd_vf$creat_max >= bdd_vf$creat_ref + bdd_vf$creat_ref * 30/100, 1, 0))
levels(bdd_vf$hemorragie_evol)[levels(bdd_vf$hemorragie_evol)=="Infarctus splénique + Ischémie des 2 pieds"]<-"1"
bdd_vf$temp<-as.factor(ifelse(as.numeric(bdd_vf$temp) >= 37.8, 1, ifelse(is.na(as.numeric(bdd_vf$temp)), NA, 0)))
bdd_vf$temp_evol<-as.factor(ifelse(bdd_vf$temp_max_evol >= 37.7 | bdd_vf$temp_min_evol<=35.6, 1,
ifelse(is.na(bdd_vf$temp_max_evol) & is.na(bdd_vf$temp_min_evol), NA, 0)))
bdd_vf$ipp_tot<-as.factor(ifelse(bdd_vf$IPP == 1 | bdd_vf$IPP_TAD == 1, 1,
ifelse(bdd_vf$IPP == 0 | bdd_vf$IPP_TAD == 0, 0, NA)))
bdd_vf$AC_tot<-as.factor(ifelse(bdd_vf$ACC_preH == 1 | bdd_vf$ACC_evol == 1 | bdd_vf$hep_prev == 1, 1,
ifelse(is.na(bdd_vf$ACC_preH) & is.na(bdd_vf$ACC_evol) & is.na(bdd_vf$hep_prev), NA, 0)))
bdd_vf$oxygene<-as.factor(ifelse(bdd_vf$oxygene != 0 & bdd_vf$oxygene != 1, NA, bdd_vf$oxygene))
bdd_vf$agueusie<-as.factor(ifelse(bdd_vf$agueusie==6, NA, bdd_vf$agueusie))
bdd_vf$myalgie<-as.factor(ifelse(bdd_vf$myalgie=="à", NA, bdd_vf$myalgie))
bdd_vf<-bdd_vf %>% filter(age != min(age, na.rm = TRUE))
bdd_vf$adl_quali<-as.factor(ifelse(bdd_vf$ADL6 >= 4, 1,
ifelse(is.na(bdd_vf$ADL6), NA, 0)))
bdd_vf$infection_evol<-as.factor(ifelse(bdd_vf$infection_evol == "2", NA,
as.factor(bdd_vf$infection_evol)))
bdd_vf$infection_evol<-droplevels(bdd_vf$infection_evol)
summary(bdd_vf$infection_evol)
bdd_vf$marbure_evol<-as.factor(ifelse(bdd_vf$marbure_evol == "0+DK43", NA,
as.factor(bdd_vf$marbure_evol)))
bdd_vf$ACC_tot<-as.factor(ifelse(bdd_vf$ACC_evol==1 | bdd_vf$ACC_preH == 1, 1,
ifelse(is.na(bdd_vf$ACC_preH) | is.na(bdd_vf$ACC_evol), NA, 0)))
summary(bdd_vf$ACC_tot)
bdd_vf$o2Max2<-as.factor(ifelse(is.na(bdd_vf$o2Max) | bdd_vf$o2Max < 6, 0, 1))
bdd_vf$deces[is.na(bdd_vf$deces)] <-0
##### Subset final ####
bdd_subset <- bdd_vf %>%
select ("centre", "n_centre", "age", "sexe", "depression","demence","icard" ,"avc", "park", "hta", "diab", "acfa", "obese", "icoro", "irenC", "mtev", "K", "bpco", "ugd", "charleson","charlson_ajuste",
"AAP", "AVK", "AOD", "IEC", "ara2", "BB", "IPP_TAD", "bzd", "nlp", "nb_medoc" ,"institution", "ADL6", "adl_quali" , "Rockwood", "temp", "hypoTA_preH", "asthenie",
"dyspnee", "toux", "DT", "myalgie", "cephalee", "douleur_phar", "diarrhee","qsofa_preH" ,"nausee_vomissement", "douleur_abdo", "confusion", "anosmie", "agueusie", "cont_noS",
"infNoso", "pcr_pos", "anomalie_imagerie", "delais_hospit","OAP_evol", "sca_evol", "DT_evol", "FA_parox", "DRA_evol", "IRA", "confusion_evol", "mtev_evol",
"hemorragie_evol", "temp_evol","dyspnee_evol","AVC_evol", "diarree_evol", "asthenie_evol", "escarre_evol","fecalome_evol", "globe_evol", "hypoTA_evol", "qsofa_evol", "devenir", "lata_evol", "Leuco.Max",
"lympho", "Hb.MIN", "Thrombopenie.NADIR", "creat_max", "Na_max", "K_min", "alb", "cytolyse", "cholestase", "LDH.max", "CRP.max", "PCT.MAX", "Ferritine.max",
"ARV", "cortico", "HCQ", "immunoM", "oxygene", "VNI", "ATB", "IPP", "transfu_evol", "mida", "morphine", "hep_prev", "ACC_preH", "ACC_evol",
"ipp_tot", "AC_tot", "sevrage_iec_ara2", "deces", "prov", "DMS", "date_intro_cortico", "delais_intro_ctc", "ACC_tot", "rea_evol", "o2Max2","surv")
summary(bdd_subset)
bdd_subset$Leuco.Max<-ifelse(bdd_subset$Leuco.Max > 1000, bdd_subset$Leuco.Max/1000, bdd_subset$Leuco.Max)
bdd_subset$lympho<-ifelse(bdd_subset$lympho > 100, bdd_subset$lymphox/1000, bdd_subset$lympho)
bdd_subset$age_quali<-as.factor(ifelse(bdd_subset$age <= 79, "70-79",
ifelse(bdd_subset$age <= 85, "80-85",
ifelse(bdd_subset$age <= 90, "86-90", "> 90"))))
bdd_subset$dyspnee<-as.factor(ifelse(is.na(bdd_vf$dyspnee) & bdd_vf$FR >= 22, 1,
ifelse(bdd_vf$dyspnee==1, 1, 0)))
bdd_subset$qsofa_quali_preH<-as.factor(ifelse(bdd_vf$qsofa_preH >=2, 1,
ifelse(bdd_vf$qsofa_preH < 2, 0, NA)))
bdd_subset$qsofa_quali_evol<-as.factor(ifelse(bdd_vf$qsofa_evol >=2, 1,
ifelse(bdd_vf$qsofa_evol < 2, 0,
NA)))
# bdd_subset$anomalie_imagerie<-addNA(bdd_subset$anomalie_imagerie)
summary(bdd_subset$anomalie_imagerie)
bdd_subset$imagery<-bdd_subset$anomalie_imagerie
bdd_subset$imagery[is.na(bdd_subset$imagery)]<-"0"
summary(bdd_subset$imagery)
bdd_subset$anomalie_imagerie<-factor(ifelse(is.na(bdd_subset$anomalie_imagerie),
"Not performed",
paste(bdd_subset$anomalie_imagerie)),
levels = c(levels(bdd_subset$anomalie_imagerie),
"Not performed"))
summary(bdd_subset$anomalie_imagerie)
#write.csv2(bdd_subset, "bdd_subset.csv")
setwd("/Users/Tiago/Desktop/BF is cool/gerocovid/bases")
require(dplyr)
require(lubridate)
bdd_vf<-read.csv2("bdd_cons.csv")
summary(bdd_vf)
# Dernieres lignes de DM sur la base finale:
bdd_vf$centre<-gsub("psl", "PSL", bdd_vf$centre)
bdd_vf$centre<-gsub("abc", "ABC", bdd_vf$centre)
bdd_vf$centre<-gsub("mondor", "HMN", bdd_vf$centre, ignore.case = TRUE)
for (i in 1:ncol(bdd_vf)){
if (i <= ncol(bdd_vf) && ((is.numeric(bdd_vf[,i]) && mean(bdd_vf[,i], na.rm = TRUE) < 1) || is.character(bdd_vf[,i])))
{
print(paste("to factor", colnames(bdd_vf)[i], sep="_"))
bdd_vf[,i]<-as.factor(as.character(bdd_vf[,i]))
}
if (nlevels(bdd_vf[,i]) > 5 && colnames(bdd_vf)[i] != "centre"){
print(paste("to char", colnames(bdd_vf)[i], sep="_"))
bdd_vf[,i]<-as.character(bdd_vf[,i])
if (!is.na(mean(as.numeric(bdd_vf[,i]), na.rm = TRUE)) && colnames(bdd_vf)[i] != "typeK")
{
print(paste("to num", colnames(bdd_vf)[i], sep="_"))
bdd_vf[,i]<-as.numeric(bdd_vf[,i])}
}
}
bdd_vf$charleson = NA
table(bdd_vf$K, bdd_vf$typeK)
bdd_vf$K<-as.factor(ifelse(bdd_vf$typeK == "Sein", 1,
ifelse(bdd_vf$K==1, 1, ifelse(bdd_vf$K==0, 0, NA))))
bdd_vf$typeK= gsub(".*met.*", "meta", bdd_vf$typeK, ignore.case = TRUE)
bdd_vf$charleson<-ifelse(bdd_vf$diab==1, 1, 0) + ifelse(bdd_vf$bpco == 1, 1, 0) + ifelse(bdd_vf$ugd == 1, 1, 0) +
ifelse(bdd_vf$demence == 1, 2, 0) + ifelse(bdd_vf$avc==1, 1, 0)  + ifelse(bdd_vf$aomi ==1, 1, 0) + ifelse(bdd_vf$icard == 1, 1, 0) +
ifelse(bdd_vf$icoro == 1, 1, 0) + ifelse(bdd_vf$K==1, 2, 0) + ifelse(bdd_vf$hemi_par == 1, 2, 0) + ifelse(bdd_vf$irenC == 1, 1, 0) +
ifelse(bdd_vf$typeK=="meta", 6, 0)
bdd_vf$charleson[bdd_vf$typeK=="LYMPHOME+ CANCER SEIN"]<- bdd_vf$charleson[bdd_vf$typeK=="LYMPHOME+ CANCER SEIN"] + 2
bdd_vf$charlson_ajuste<-as.numeric(ifelse(bdd_vf$age <= 79, bdd_vf$charleson + 3,
ifelse(bdd_vf$age <= 89, bdd_vf$charleson + 4,
ifelse (bdd_vf$age >= 90, bdd_vf$charleson + 5, NA))))
for (i in 1:ncol(bdd_vf))
if (is.factor(bdd_vf[,i]) && colnames(bdd_vf)[i] != "sevrage_iec_ara2" && colnames(bdd_vf)[i] != "hep_prev")
levels(bdd_vf[,i])[levels(bdd_vf[,i])=="ND" | levels(bdd_vf[,i]) =="NC" | levels(bdd_vf[,i]) == "" | levels(bdd_vf[,i]) == "?" | levels(bdd_vf[,i]) == "nd"] <-NA
bdd_vf$qsofa_preH<-as.numeric(as.character(bdd_vf$hypoTA_preH)) + as.numeric(as.character(bdd_vf$confusion)) +
as.numeric(as.character(bdd_vf$DRA))
bdd_vf$qsofa_evol<-ifelse(bdd_vf$hypoTA_evol==1, 1, 0) +
ifelse(bdd_vf$confusion_evol==1, 1, 0) +
ifelse(bdd_vf$DRA_evol==1, 1, 0)
bdd_vf$date_DC[bdd_vf$X=="287"] <- "23/04/20"
bdd_vf$date_DC<-gsub("/20$", "/2020", bdd_vf$date_DC)
bdd_vf$date_DC<-as.Date(bdd_vf$date_DC, "%d/%m/%Y")
summary(bdd_vf$date_DC)
bdd_vf$date_symp<-as.character(bdd_vf$date_symp)
bdd_vf$date_symp[bdd_vf$X=="576"] <- "27/01/2020"
bdd_vf$date_symp<-gsub("/20$", "/2020", bdd_vf$date_symp)
bdd_vf$date_symp<-gsub("/2030$", "/2020", bdd_vf$date_symp)
bdd_vf$date_symp<-as.Date(bdd_vf$date_symp, "%d/%m/%Y")
summary(bdd_vf$date_symp)
bdd_vf$date_eh<-gsub("/20$", "/2020", bdd_vf$date_eh)
bdd_vf$date_eh<-as.Date(bdd_vf$date_eh, "%d/%m/%Y")
summary(bdd_vf$date_eh)
bdd_vf$date_uga<-gsub("/20$", "/2020", bdd_vf$date_uga)
bdd_vf$date_uga<-as.Date(bdd_vf$date_uga, "%d/%m/%Y")
summary(bdd_vf$date_uga)
bdd_vf$date_s<-gsub("/20$", "/2020", bdd_vf$date_s)
bdd_vf$date_s<-as.Date(bdd_vf$date_s, "%d/%m/%Y")
summary(bdd_vf$date_s)
bdd_vf$DMS<- as.numeric(bdd_vf$date_s- bdd_vf$date_uga)
bdd_vf$surv <- as.numeric(bdd_vf$date_s - bdd_vf$date_symp)
bdd_vf$surv<-as.numeric(ifelse(bdd_vf$surv < 0, NA, bdd_vf$surv))
bdd_vf$delais_hospit<-as.numeric(bdd_vf$date_uga - bdd_vf$date_symp)
summary(bdd_vf$delais_hospit)
bdd_vf$delais_hospit[bdd_vf$delais_hospit < 0]<- NA
bdd_vf$date_intro_cortico
bdd_vf$date_intro_cortico<-gsub("/20$", "/2020", bdd_vf$date_intro_cortico)
bdd_vf$date_intro_cortico[bdd_vf$date_intro_cortico=="30-mars"]<-"03/03/2020"
bdd_vf$date_intro_cortico[bdd_vf$date_intro_cortico==""]<-NA
bdd_vf$date_intro_cortico<-as.Date(bdd_vf$date_intro_cortico, "%d/%m/%Y")
summary(bdd_vf$date_intro_cortico)
bdd_vf$delais_intro_ctc<-as.numeric(bdd_vf$date_intro_cortico - bdd_vf$date_uga)
bdd_vf$prov<-gsub(".*dom.*", "Domicile", bdd_vf$prov, ignore.case = TRUE)
bdd_vf$prov<-gsub(".*SAU.*|.*urg.*", "SAU", bdd_vf$prov, ignore.case = TRUE)
bdd_vf$prov<-gsub(".*m(é|e).*|.*chir.*|.*orth.*|.*mco.*|.*UGA.*", "MCO", bdd_vf$prov, ignore.case = TRUE)
bdd_vf$prov<-gsub(".*EHPAD.*|.*SLD.*", "Domicile", bdd_vf$prov, ignore.case = TRUE)
bdd_vf$prov<-gsub(".*ssr.*", "SSR", bdd_vf$prov, ignore.case = TRUE)
bdd_vf$prov<-ifelse(bdd_vf$prov != "" & bdd_vf$prov != "Domicile" &
bdd_vf$prov != "MCO" & bdd_vf$prov != "SAU"
& bdd_vf$prov != "SSR", "MCO", bdd_vf$prov)
bdd_vf$prov <- as.factor(bdd_vf$prov)
levels(bdd_vf$prov)[levels(bdd_vf$prov)==""] <- NA
summary(bdd_vf$prov)
bdd_vf$IMC<-as.numeric(ifelse(bdd_vf$IMC==0, NA, bdd_vf$IMC))
bdd_vf$IMC <- as.numeric(ifelse(is.na(bdd_vf$IMC) & !is.na(as.numeric(bdd_vf$poids) & !is.na(as.numeric(bdd_vf$taille))),
bdd_vf$poids/(bdd_vf$taille^2), bdd_vf$IMC))
bdd_vf$IMC[bdd_vf$IMC==max(bdd_vf$IMC, na.rm = TRUE)]<-NA
bdd_vf$infection_evol[bdd_vf$infection_evol==2]<-NA
bdd_vf$IRA<-as.factor(ifelse(bdd_vf$creat_max >= bdd_vf$creat_ref + bdd_vf$creat_ref * 30/100, 1, 0))
levels(bdd_vf$hemorragie_evol)[levels(bdd_vf$hemorragie_evol)=="Infarctus splénique + Ischémie des 2 pieds"]<-"1"
bdd_vf$temp<-as.factor(ifelse(as.numeric(bdd_vf$temp) >= 37.8, 1, ifelse(is.na(as.numeric(bdd_vf$temp)), NA, 0)))
bdd_vf$temp_evol<-as.factor(ifelse(bdd_vf$temp_max_evol >= 37.7 | bdd_vf$temp_min_evol<=35.6, 1,
ifelse(is.na(bdd_vf$temp_max_evol) & is.na(bdd_vf$temp_min_evol), NA, 0)))
bdd_vf$ipp_tot<-as.factor(ifelse(bdd_vf$IPP == 1 | bdd_vf$IPP_TAD == 1, 1,
ifelse(bdd_vf$IPP == 0 | bdd_vf$IPP_TAD == 0, 0, NA)))
bdd_vf$AC_tot<-as.factor(ifelse(bdd_vf$ACC_preH == 1 | bdd_vf$ACC_evol == 1 | bdd_vf$hep_prev == 1, 1,
ifelse(is.na(bdd_vf$ACC_preH) & is.na(bdd_vf$ACC_evol) & is.na(bdd_vf$hep_prev), NA, 0)))
bdd_vf$oxygene<-as.factor(ifelse(bdd_vf$oxygene != 0 & bdd_vf$oxygene != 1, NA, bdd_vf$oxygene))
bdd_vf$agueusie<-as.factor(ifelse(bdd_vf$agueusie==6, NA, bdd_vf$agueusie))
bdd_vf$myalgie<-as.factor(ifelse(bdd_vf$myalgie=="à", NA, bdd_vf$myalgie))
bdd_vf<-bdd_vf %>% filter(age != min(age, na.rm = TRUE))
bdd_vf$adl_quali<-as.factor(ifelse(bdd_vf$ADL6 >= 4, 1,
ifelse(is.na(bdd_vf$ADL6), NA, 0)))
bdd_vf$infection_evol<-as.factor(ifelse(bdd_vf$infection_evol == "2", NA,
as.factor(bdd_vf$infection_evol)))
bdd_vf$infection_evol<-droplevels(bdd_vf$infection_evol)
summary(bdd_vf$infection_evol)
bdd_vf$marbure_evol<-as.factor(ifelse(bdd_vf$marbure_evol == "0+DK43", NA,
as.factor(bdd_vf$marbure_evol)))
bdd_vf$ACC_tot<-as.factor(ifelse(bdd_vf$ACC_evol==1 | bdd_vf$ACC_preH == 1, 1,
ifelse(is.na(bdd_vf$ACC_preH) | is.na(bdd_vf$ACC_evol), NA, 0)))
summary(bdd_vf$ACC_tot)
bdd_vf$o2Max2<-as.factor(ifelse(is.na(bdd_vf$o2Max) | bdd_vf$o2Max < 6, 0, 1))
bdd_vf$deces[is.na(bdd_vf$deces)] <-0
##### Subset final ####
bdd_subset <- bdd_vf %>%
select ("centre", "n_centre", "age", "sexe", "depression","demence","icard" ,"avc", "park", "hta", "diab", "acfa", "obese", "icoro", "irenC", "mtev", "K", "bpco", "ugd", "charleson","charlson_ajuste",
"AAP", "AVK", "AOD", "IEC", "ara2", "BB", "IPP_TAD", "bzd", "nlp", "nb_medoc" ,"institution", "ADL6", "adl_quali" , "Rockwood", "temp", "hypoTA_preH", "asthenie",
"dyspnee", "toux", "DT", "myalgie", "cephalee", "douleur_phar", "diarrhee","qsofa_preH" ,"nausee_vomissement", "douleur_abdo", "confusion", "anosmie", "agueusie", "cont_noS",
"infNoso", "pcr_pos", "anomalie_imagerie", "delais_hospit","OAP_evol", "sca_evol", "DT_evol", "FA_parox", "DRA_evol", "IRA", "confusion_evol", "mtev_evol",
"hemorragie_evol", "temp_evol","dyspnee_evol","AVC_evol", "diarree_evol", "asthenie_evol", "escarre_evol","fecalome_evol", "globe_evol", "hypoTA_evol", "qsofa_evol", "devenir", "lata_evol", "Leuco.Max",
"lympho", "Hb.MIN", "Thrombopenie.NADIR", "creat_max", "Na_max", "K_min", "alb", "cytolyse", "cholestase", "LDH.max", "CRP.max", "PCT.MAX", "Ferritine.max",
"ARV", "cortico", "HCQ", "immunoM", "oxygene", "VNI", "ATB", "IPP", "transfu_evol", "mida", "morphine", "hep_prev", "ACC_preH", "ACC_evol",
"ipp_tot", "AC_tot", "sevrage_iec_ara2", "deces", "prov", "DMS", "date_intro_cortico", "delais_intro_ctc", "ACC_tot", "rea_evol", "o2Max2","surv")
summary(bdd_subset)
bdd_subset$Leuco.Max<-ifelse(bdd_subset$Leuco.Max > 1000, bdd_subset$Leuco.Max/1000, bdd_subset$Leuco.Max)
bdd_subset$lympho<-ifelse(bdd_subset$lympho > 100, bdd_subset$lymphox/1000, bdd_subset$lympho)
bdd_subset$age_quali<-as.factor(ifelse(bdd_subset$age <= 79, "70-79",
ifelse(bdd_subset$age <= 85, "80-85",
ifelse(bdd_subset$age <= 90, "86-90", "> 90"))))
bdd_subset$dyspnee<-as.factor(ifelse(is.na(bdd_vf$dyspnee) & bdd_vf$FR >= 22, 1,
ifelse(bdd_vf$dyspnee==1, 1, 0)))
bdd_subset$qsofa_quali_preH<-as.factor(ifelse(bdd_vf$qsofa_preH >=2, 1,
ifelse(bdd_vf$qsofa_preH < 2, 0, NA)))
bdd_subset$qsofa_quali_evol<-as.factor(ifelse(bdd_vf$qsofa_evol >=2, 1,
ifelse(bdd_vf$qsofa_evol < 2, 0,
NA)))
# bdd_subset$anomalie_imagerie<-addNA(bdd_subset$anomalie_imagerie)
summary(bdd_subset$anomalie_imagerie)
bdd_subset$imagery<-bdd_subset$anomalie_imagerie
bdd_subset$imagery[is.na(bdd_subset$imagery)]<-"0"
summary(bdd_subset$imagery)
bdd_subset$anomalie_imagerie<-factor(ifelse(is.na(bdd_subset$anomalie_imagerie),
"Not performed",
paste(bdd_subset$anomalie_imagerie)),
levels = c(levels(bdd_subset$anomalie_imagerie),
"Not performed"))
summary(bdd_subset$anomalie_imagerie)
#write.csv2(bdd_subset, "bdd_subset.csv")
library(doudpackage)
ana<-ft_univ_tab(bdd_subset, "deces", na.print = T, p.value = T, digits.opt = 0)
write.csv2(ana, "ana.csv")
View(ana)
153 + 56
tmp<-filter(bdd_subset, anomalie_imagrie!=" Not performed")
tmp<-filter(bdd_subset, anomalie_imagerie!=" Not performed")
ana_tmp<-ft_ana_biv(bdd_subset, "deces")
View(ana_tmp)
summary(bdd_subset$anomalie_imagerie)
tmp<-filter(bdd_subset, anomalie_imagerie!=" Not performed")
tmp<-filter(bdd_subset, anomalie_imagerie==" Not performed")
tmp<-filter(bdd_subset, anomalie_imagerie!="Not performed")
ana_tmp<-ft_ana_biv(bdd_subset, "deces")
ana_tmp<-ft_ana_biv(tmp, "deces")
ana_biv<-ft_ana_biv(bdd_subset, "deces")
View(ana_tmp)
View(ana_biv)
colnames(bdd_subset)
colnames(bdd_vf)
bdd_vf[order(colnames(bdd_vf)),)
bdd_vf[order(colnames(bdd_vf)),]
colnames(bdd_vf)
summary(bdd_vf$type_imagerie)
summary(as.factor(bdd_vf$type_imagerie))
summary(bdd_subset$imagery)
summary(tmp$imagery)
summary(tmp$anomalie_imagerie)
library(devtools)
help(package=="doudpackage")
help(package="doudpackage")
install.packages("devtools")
library(devtools)
install_github("tiago972/doudpackage")
library(doudpackage)
